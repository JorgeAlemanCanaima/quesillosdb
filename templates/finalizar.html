{% extends "layout.html" %}

{% block title %}
    Mesas
{% endblock %}

{% block main %}
  <div class="container-fluid">
    
    <div class="card shadow">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-auto">
                    <a href="{{ url_for('editar_pedido', pedido_id=info[0]['pedido_id']) }}" class="btn btn-secondary d-flex align-items-center">
                        <img style="height: 20px; width: 20px;" src="../static/images/logos/editar.png" alt="Editar" width="16" height="16">
                    </a>
                </div>
                <div class="col">
                    <h4 class="mb-0">Editar Pedido</h4>
                </div>
            </div>

            <div class="row mt-3">
                <h5 class="text-center">Fecha: {{ info[0]['fecha'] }}</h5>
                <h5 class="text-center">Mesa: {{ info[0]['mesa_id'] }}</h5>
            </div>

            <div class="row mt-3">
                <div class="col text-center">
                    <h4>Subtotal: C$ <span id="subtotal">{{ "%.2f"|format(info[0]['total_monto']) }}</span></h4>
                    <h5>Propina (10%): C$ <span id="propina">{{ "%.2f"|format(info[0]['total_monto'] * 0.10) }}</span></h5>
                    <h3 style="background-color: #baccf0; padding: 5px;">Total: C$ <span id="total">{{ "%.2f"|format(info[0]['total_monto']) }}</span></h3>
                </div>
            </div>

            <div class="row mt-3">
                <div class="table-responsive">
                    <table class="table text-nowrap align-middle mb-0">
                      <thead>
                        <tr class="border-2 border-bottom border-primary border-0"> 
                          <th scope="col">Producto</th>
                          <th scope="col">Precio Unitario</th>
                          <th scope="col">Cantidad</th>
                          <th scope="col">Subtotal</th>
                        </tr>
                      </thead>
                      <tbody class="table-group-divider">
                        {% for i in info %}
                          <tr>        
                            <td>{{ i['producto_nombre'] }}</td>
                            <td>C$ {{ "%.2f"|format(i['producto_precio']) }}</td>
                            <td>{{ i['cantidad'] }}</td>
                            <td>C$ {{ "%.2f"|format(i['cantidad'] * i['producto_precio']) }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                </div>
            </div>

            <div class="row mt-3">
              <div class="col-12">
                <form action="{{ url_for('finalizar', mesa_id=info[0]['mesa_id']) }}" method="POST">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="propinaSwitch" name="propina" value="1" checked>
                    <label class="form-check-label" for="propinaSwitch">Â¿Incluir propina (10%)?</label>
                    <input type="hidden" id="propinaValue" name="propina_value" value="{{ "%.2f"|format(info[0]['total_monto'] * 0.10) }}">
                  </div>
                  <button type="submit" class="btn btn-primary w-100 text-center mt-2">
                    ðŸ›’ Finalizar Pedido
                  </button>
                </form>
              </div>
            </div>

        </div>
    </div>
  </div>

  <!-- JavaScript exclusivo para manejo de propina -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
        const propinaSwitch = document.getElementById("propinaSwitch");
        const propinaValue = document.getElementById("propinaValue");
        const subtotal = parseFloat(document.getElementById("subtotal").innerText);
        const propinaElement = document.getElementById("propina");
        const totalElement = document.getElementById("total");
        const propinaBase = parseFloat(propinaElement.innerText);

        propinaSwitch.addEventListener("change", function() {
            if (this.checked) {
                totalElement.innerText = (subtotal + propinaBase).toFixed(2);
                propinaValue.value = propinaBase.toFixed(2);
            } else {
                totalElement.innerText = subtotal.toFixed(2);
                propinaValue.value = "0.00";
            }
        });

        // Inicializar con propina activada por defecto
        propinaSwitch.dispatchEvent(new Event('change'));
    });
  </script>
{% endblock %}