{% extends "layout.html" %}
{% block title %}Usuarios{% endblock %}

{% block main %}
<div class="container py-4">
  <h2>Usuarios</h2>

  <!-- ▽ FORMULARIO de registro ▽ -->
  <form id="registerForm" class="row g-3 mb-4" method="post" action="{{ url_for('usuarios') }}">
    <div class="col-md-4">
      <label class="form-label">Usuario</label>
      <input name="usuario" type="text" class="form-control" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Rol</label>
      <select name="rol" class="form-select" required>
        <option value="">—</option>
        <option>Admin</option>
        <option>Mesero</option>
        <option>Cajero</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Contraseña</label>
      <input name="password" type="password" class="form-control" required minlength="4">
    </div>
    <div class="col-12">
      <button class="btn btn-primary">Registrar</button>
    </div>
  </form>

  <!-- ▽ LISTADO ▽ -->
  <table class="table table-striped">
    <thead>
      <tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr data-id="{{ u.id }}">
        <td class="td-name">{{ u.nombre_user }}</td>
        <td class="td-role">{{ u.rol }}</td>
        <td>
          <button class="btn btn-sm btn-warning btn-edit">✎</button>
          <button class="btn btn-sm btn-danger btn-delete">✕</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal EDITAR -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog">
    <form class="modal-content" id="editForm">
      <div class="modal-header">
        <h5 class="modal-title">Editar Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="mb-3">
          <label class="form-label">Usuario</label>
          <input id="editName" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Rol</label>
          <select id="editRole" class="form-select" required>
            <option>Admin</option>
            <option>Mesero</option>
            <option>Cajero</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Nueva contraseña (opcional)</label>
          <input id="editPwd" type="password" class="form-control" minlength="4">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", ()=> {
  const editModal = new bootstrap.Modal(document.getElementById("editModal"));
  const editForm  = document.getElementById("editForm");

  // ELIMINAR
  document.querySelectorAll(".btn-delete").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tr = btn.closest("tr"), id = tr.dataset.id;
      if (!confirm("¿Eliminar este usuario?")) return;
      fetch(`/usuarios/eliminar/${id}`, { method: "DELETE" })
        .then(r=>r.json())
        .then(j=>{
          if (j.status==="success") tr.remove();
          else alert(j.message);
        });
    });
  });

  // EDITAR → abrir modal
  document.querySelectorAll(".btn-edit").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tr = btn.closest("tr"), id = tr.dataset.id;
      document.getElementById("editId").value   = id;
      document.getElementById("editName").value = tr.querySelector(".td-name").textContent;
      document.getElementById("editRole").value = tr.querySelector(".td-role").textContent;
      document.getElementById("editPwd").value  = "";
      editModal.show();
    });
  });

  // EDITAR → submit
  editForm.addEventListener("submit", e=>{
    e.preventDefault();
    const id = +document.getElementById("editId").value;
    const body = {
      nombre_user: document.getElementById("editName").value.trim(),
      rol:         document.getElementById("editRole").value,
      contra_user: document.getElementById("editPwd").value
    };
    fetch(`/usuarios/editar/${id}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    })
    .then(r=>r.json())
    .then(j=>{
      if (j.status==="success") {
        const tr = document.querySelector(`tr[data-id='${id}']`);
        tr.querySelector(".td-name").textContent = j.nombre_user;
        tr.querySelector(".td-role").textContent = j.rol;
        editModal.hide();
      } else alert(j.message);
    });
  });
});
</script>
{% endblock %}
