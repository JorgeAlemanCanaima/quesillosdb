<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quesillos lo nuestro {% block title %} {% endblock %}</title>
  <link rel="shortcut icon" type="image/png" href="../static/images/logos/logo.jpg" />
  <link rel="stylesheet" href="../static/css/styles.min.css" />
  <!-- Bootstrap Icons CDN -->
   
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* Estilos base */
    .sidebar-nav {
      max-height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* Mejora el scroll en iOS */
      padding-bottom: 100px; /* Espacio extra al final para asegurar que todos los elementos sean accesibles */
    }

    /* Estilos para notificaciones */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }

    .toast {
      min-width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-bottom: 10px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast-header {
      background: linear-gradient(45deg, #8d6e63, #bcaaa4);
      color: white;
      border-radius: 8px 8px 0 0;
      padding: 0.75rem 1rem;
    }

    .toast-body {
      padding: 1rem;
      color: #333;
    }

    /* Estilos responsivos */
    @media (max-width: 991.98px) {
      .sidebar-nav {
        max-height: calc(100vh - 60px);
        padding-bottom: 150px; /* Más espacio en móviles */
      }
      
      .brand-logo img {
        width: 150px !important;
        height: 75px !important;
      }

      .left-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        transform: translateX(-100%);
        height: 100%;
        z-index: 1030;
        transition: transform 0.3s ease;
        background-color: #fff;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        width: 260px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* Mejora el scroll en iOS */
        right: auto;
        will-change: transform;
        display: block;
      }

      .left-sidebar.show {
        transform: translateX(0) !important;
        left: 0 !important;
        right: auto !important;
        display: block !important;
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .mobile-toggle {
        display: block !important;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1031;
        background: #fff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }

      .mobile-toggle i {
        font-size: 1.2rem;
        color: #333;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1029;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .sidebar-overlay.show {
        display: block;
        opacity: 1;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 1.2rem;
        color: #333;
        cursor: pointer;
        padding: 5px;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        transform: rotate(90deg);
        color: #dc3545;
      }

      .body-wrapper {
        margin-left: 0 !important;
      }

      /* Mejoras para móvil */
      .container-fluid {
        padding: 0.5rem;
      }

      .table-responsive {
        margin: 0;
        padding: 0;
      }

      .card {
        margin-bottom: 1rem;
      }

      .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .modal-dialog {
        margin: 0.5rem;
      }

      /* Ajustes responsivos para notificaciones */
      .toast-container {
        top: auto;
        bottom: 20px;
        right: 10px;
        left: 10px;
      }

      .toast {
        min-width: auto;
        width: 100%;
        margin-bottom: 8px;
      }

      .toast-header {
        padding: 0.5rem 0.75rem;
      }

      .toast-body {
        padding: 0.75rem;
      }
    }

    /* Estilos específicos para 394x852 */
    @media (max-width: 394px) {
      .brand-logo img {
        width: 120px !important;
        height: 60px !important;
      }

      .mobile-toggle {
        top: 8px;
        left: 8px;
        width: 35px;
        height: 35px;
      }

      .mobile-toggle i {
        font-size: 1rem;
      }

      .left-sidebar {
        width: 260px;
      }

      .sidebar-link {
        padding: 8px !important;
        font-size: 14px !important;
      }

      .sidebar-link i {
        font-size: 18px !important;
      }

      .nav-small-cap {
        font-size: 11px !important;
        margin-top: 15px !important;
      }

      .container-fluid {
        padding: 0.25rem;
      }

      .card {
        margin-bottom: 0.75rem;
      }

      .card-body {
        padding: 0.75rem;
      }

      .table th, .table td {
        padding: 0.5rem;
        font-size: 0.85rem;
      }

      .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
      }

      .form-control {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
      }

      .modal-dialog {
        margin: 0.25rem;
      }

      .modal-content {
        border-radius: 0.5rem;
      }

      .modal-header {
        padding: 0.75rem;
      }

      .modal-body {
        padding: 0.75rem;
      }

      .modal-footer {
        padding: 0.75rem;
      }

      /* Ajustes para el header */
      .app-header {
        padding: 0 10px;
      }

      .app-header .navbar {
        min-height: 60px;
      }

      .app-header .navbar .navbar-nav .nav-item .nav-link {
        padding: 4px 8px;
        line-height: 60px;
        height: 60px;
        font-size: 18px;
      }

      /* Ajustes para dropdowns */
      .dropdown-menu {
        width: 100%;
        margin-top: 0.5rem;
        font-size: 0.875rem;
      }

      .dropdown-item {
        padding: 0.5rem 0.75rem;
      }

      /* Ajustes para notificaciones */
      .toast-container {
        bottom: 10px;
        right: 5px;
        left: 5px;
      }

      .toast {
        margin-bottom: 5px;
      }

      /* Ajustes para el contenido principal */
      .body-wrapper > .container-fluid {
        padding: 10px;
      }

      /* Ajustes para tablas */
      .table-responsive {
        margin: 0 -10px;
        padding: 0 10px;
      }

      /* Ajustes para formularios */
      .form-label {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .input-group {
        flex-wrap: wrap;
      }

      .input-group > * {
        margin-bottom: 0.25rem;
      }

      /* Ajustes para botones de acción */
      .btn-group {
        display: flex;
        flex-direction: column;
      }

      .btn-group .btn {
        margin-bottom: 0.25rem;
      }
    }

    @media (max-width: 767.98px) {
      .brand-logo img {
        width: 150px !important;
        height: 75px !important;
      }
      
      .navbar-nav {
        padding: 0.5rem;
      }
      
      .container-fluid {
        padding: 0.5rem;
      }

      /* Ajustes adicionales para móvil */
      .table th, .table td {
        padding: 0.5rem;
        font-size: 0.9rem;
      }

      .card-body {
        padding: 1rem;
      }

      .btn-group {
        display: flex;
        flex-direction: column;
      }

      .btn-group .btn {
        margin-bottom: 0.5rem;
      }

      .dropdown-menu {
        width: 100%;
        margin-top: 0.5rem;
      }
    }

    /* Mejoras generales de responsividad */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .img-fluid {
      max-width: 100%;
      height: auto;
    }

    .flex-wrap {
      flex-wrap: wrap;
    }

    /* Mejoras para formularios */
    .form-control {
      width: 100%;
    }

    .input-group {
      flex-wrap: wrap;
    }

    .input-group > * {
      margin-bottom: 0.5rem;
    }

    /* Mejoras para modales */
    .modal-content {
      border-radius: 0.5rem;
    }

    @media (max-width: 575.98px) {
      .modal-dialog {
        margin: 0.25rem;
      }

      .card {
        border-radius: 0.5rem;
      }

      .btn {
        padding: 0.375rem 0.75rem;
      }
    }

    /* Mejoras para la navegación */
    .navbar {
      padding: 0.5rem;
    }

    .nav-link {
      padding: 0.5rem;
    }

    /* Mejoras para las alertas */
    .alert {
      margin: 0.5rem;
      border-radius: 0.5rem;
    }

    /* Mejoras para los badges */
    .badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }

    /* Mejoras para los tooltips */
    .tooltip {
      font-size: 0.875rem;
    }

    /* Mejoras para los popovers */
    .popover {
      max-width: 90%;
    }

    .sidebar-link {
      transition: all 0.3s ease;
    }

    .sidebar-link:hover {
      background-color: rgba(0,0,0,0.05);
    }

    .nav-icon-hover {
      transition: all 0.3s ease;
    }

    .nav-icon-hover:hover {
      transform: scale(1.1);
    }

    .dropdown-menu {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .mobile-toggle {
      display: block !important;
    }

    /* Estilos responsivos generales */
    @media (min-width: 1400px) {
      .container-fluid {
        max-width: 1320px;
        margin: 0 auto;
      }

      .left-sidebar {
        width: 280px;
      }

      .brand-logo img {
        width: 250px !important;
        height: 125px !important;
      }

      .sidebar-link {
        font-size: 16px !important;
        padding: 12px !important;
      }

      .sidebar-link i {
        font-size: 24px !important;
      }
    }

    @media (min-width: 1200px) and (max-width: 1399.98px) {
      .container-fluid {
        max-width: 1140px;
        margin: 0 auto;
      }

      .left-sidebar {
        width: 260px;
      }

      .brand-logo img {
        width: 220px !important;
        height: 110px !important;
      }
    }

    @media (min-width: 992px) and (max-width: 1199.98px) {
      .container-fluid {
        max-width: 960px;
        margin: 0 auto;
      }

      .left-sidebar {
        width: 240px;
      }

      .brand-logo img {
        width: 200px !important;
        height: 100px !important;
      }
    }

    @media (min-width: 768px) and (max-width: 991.98px) {
      .container-fluid {
        max-width: 720px;
        margin: 0 auto;
      }

      .left-sidebar {
        width: 220px;
      }

      .brand-logo img {
        width: 180px !important;
        height: 90px !important;
      }

      .sidebar-link {
        font-size: 15px !important;
        padding: 10px !important;
      }

      .sidebar-link i {
        font-size: 20px !important;
      }
    }

    @media (min-width: 576px) and (max-width: 767.98px) {
      .container-fluid {
        max-width: 540px;
        margin: 0 auto;
      }

      .left-sidebar {
        width: 200px;
      }

      .brand-logo img {
        width: 160px !important;
        height: 80px !important;
      }

      .sidebar-link {
        font-size: 14px !important;
        padding: 8px !important;
      }

      .sidebar-link i {
        font-size: 18px !important;
      }

      .nav-small-cap {
        font-size: 12px !important;
      }
    }

    @media (min-width: 395px) and (max-width: 575.98px) {
      .container-fluid {
        width: 100%;
        padding: 0.5rem;
      }

      .left-sidebar {
        width: 85%;
        max-width: 280px;
      }

      .brand-logo img {
        width: 140px !important;
        height: 70px !important;
      }

      .sidebar-link {
        font-size: 14px !important;
        padding: 8px !important;
      }

      .sidebar-link i {
        font-size: 18px !important;
      }

      .nav-small-cap {
        font-size: 11px !important;
      }
    }

    /* Estilos para orientación horizontal en móviles */
    @media (max-height: 500px) and (orientation: landscape) {
      .left-sidebar {
        height: 100vh;
        overflow-y: auto;
      }

      .brand-logo {
        padding: 10px;
      }

      .brand-logo img {
        width: 100px !important;
        height: 50px !important;
      }

      .sidebar-link {
        padding: 6px !important;
      }

      .nav-small-cap {
        margin-top: 10px !important;
      }

      .app-header .navbar {
        min-height: 50px;
      }

      .app-header .navbar .navbar-nav .nav-item .nav-link {
        line-height: 50px;
        height: 50px;
      }
    }

    /* Estilos para dispositivos táctiles */
    @media (hover: none) {
      .sidebar-link:hover {
        background-color: transparent;
      }

      .btn:hover {
        transform: none;
      }

      .nav-icon-hover:hover {
        transform: none;
      }

      .mobile-toggle:hover {
        transform: none;
      }

      .close-btn:hover {
        transform: none;
      }
    }
  </style>
  {% block extra_head %} {% endblock %}
</head>

<body>
  <!--  Body Wrapper -->
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    
    <!-- Botón de toggle para móvil -->
    <button class="mobile-toggle d-lg-none" id="mobileSidebarToggle">
      <i class="bi bi-list"></i>
    </button>

    <!-- Overlay para cerrar sidebar en móvil -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar Start -->
    <aside class="left-sidebar">
      <!-- Sidebar scroll-->
      <div>
        <div class="brand-logo d-flex align-items-center justify-content-between">
          <a href="" class="text-nowrap logo-img">
            <img src="../static/images/logos/logo.jpg" class="img-fluid" alt="Logo" width="300" height="150"/>
          </a>
          <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
            <i class="bi bi-x-lg"></i>
          </div>
        </div>
        <!-- Sidebar navigation-->
        <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
          <ul id="sidebarnav" class="p-0">
          
            
            
            <li class="nav-small-cap">
              <i class="ti ti-dots fs-4"></i>
              <span class="hide-menu">OPERACIONES</span>
            </li>

            {% if session.get('rol') != 'cocinero' %}
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('mesas1') }}" aria-expanded="false">
                <span>
                  <i class="ti ti-shopping-cart"></i>
                </span>
                <span class="hide-menu">Pedidos</span>
              </a>
            </li>
            {% endif %}

            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('cocina_pedidos_pendientes') }}" aria-expanded="false">
                <span>
                  <i class="ti ti-clock"></i>
                </span>
                <span class="hide-menu">Cocina</span>
              </a>
            </li>

            {% if session.get('rol') in ['admin', 'mesero', 'cocinero'] %}
            <li class="nav-small-cap">
              <i class="bi bi-boxes nav-small-cap-icon fs-6"></i>
              <span class="hide-menu">Platitllos y bebidas</span>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('entradaproductos') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-box-arrow-in-down text-danger fs-6"></i>
                </span>
                <span class="hide-menu">Entrada Producto</span>
              </a>
            </li>
            {% endif %}

            {% if session.get('rol') in ['admin', 'mesero'] %}
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('ingresoproducto') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-plus-square text-primary fs-6"></i>
                </span>
                <span class="hide-menu">Registrar producto</span>
              </a>
            </li>
            {% endif %}

            {% if session.get('rol') in ['admin'] %}
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('clientes') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-person-fill text-warning fs-6"></i>
                </span>
                <span class="hide-menu">Clientes</span>
              </a>
            </li>
            {% endif %}

            {% if session.get('rol') in ['admin', 'cajero'] %}
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('facturacion') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-file-earmark-text text-success fs-6"></i>
                </span>
                <span class="hide-menu">Historial de pedidos</span>
              </a>
            </li>
            {% endif %}
            {% if session.get('rol') == 'admin' %}
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('registro') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-box-arrow-in-down text-secondary fs-6"></i>
                </span>
                <span class="hide-menu">Historial Entrada</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('catalogoproductos') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-box-seam text-info fs-6"></i>
                </span>
                <span class="hide-menu">Listado Productos</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('historial') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-receipt text-warning fs-6"></i>
                </span>
                <span class="hide-menu">Historial de Ventas</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('mostrar_empleados') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-person-plus-fill text-success fs-6"></i>
                </span>
                <span class="hide-menu">Empleados Lista</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('cierre_corte') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-scissors text-danger fs-6"></i>
                </span>
                <span class="hide-menu">Cierre de Corte</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('movimiento_caja_page') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-cash-stack text-secondary fs-6"></i>
                </span>
                <span class="hide-menu">Gastos</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('usuarios') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-person-gear text-danger fs-4"></i>
                </span>
                <span class="hide-menu">Usuario del sistema</span>
              </a>
            </li>
              
            <li class="sidebar-item">
              <a class="sidebar-link" href="{{ url_for('respaldos') }}" aria-expanded="false">
                <span>
                  <i class="bi bi-lock"></i>
                </span>
                <span class="hide-menu">Respaldos</span>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
        <!-- End Sidebar navigation -->
      </div>
      <!-- End Sidebar scroll-->
    </aside>
    <!--  Sidebar End -->
    <!--  Main wrapper -->
    <div class="body-wrapper">
      <!--  Header Start -->
      <header class="app-header">
        <nav class="navbar navbar-expand-lg navbar-light">
          <div class="container-fluid">
            
            <div class="d-flex align-items-center ms-auto">
              <!-- Botón de ayuda de atajos -->
              <button class="btn btn-link text-dark me-3" type="button" id="shortcutsHelpBtn" title="Ver atajos de teclado">
                <i class="bi bi-keyboard"></i>
                <span class="ms-1 d-none d-md-inline">Atajos</span>
              </button>

              {% if session.get('username') %}
                {% if session.get('rol') in ['admin', 'mesero', 'cocinero'] %}
                <div class="dropdown me-3">
                  <button class="btn btn-link position-relative p-0" type="button" id="notificacionesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-bell-fill fs-5 text-dark"></i>
                    <span id="notificaciones-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; display: none;">
                      0
                    </span>
                  </button>
                  <div class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="notificacionesDropdown" style="width: 350px; max-height: 500px; overflow-y: auto; border: none; border-radius: 10px;">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                      <h6 class="mb-0">Notificaciones</h6>
                      <button class="btn btn-sm btn-link text-primary p-0" id="marcar-todas-leidas">
                        Marcar todas como leídas
                      </button>
                    </div>
                    <div id="notificaciones-lista" class="p-2">
                      <!-- Las notificaciones se cargarán aquí dinámicamente -->
                    </div>
                  </div>
                </div>
                {% endif %}
                
                <div class="dropdown">
                  <button class="btn btn-link dropdown-toggle d-flex align-items-center text-dark text-decoration-none p-0" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="fs-6">{{ session.get('username') }}</span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="userDropdown" style="border: none; border-radius: 10px; min-width: 200px;">
                    <li class="px-3 py-2 border-bottom">
                      <div class="d-flex align-items-center">
                        <div>
                          <div class="fw-bold">{{ session.get('username') }}</div>
                          <small class="text-muted">{{ session.get('rol')|title }}</small>
                        </div>
                      </div>
                    </li>
                    <li>
                      <a class="dropdown-item d-flex align-items-center py-2" href="{{ url_for('logout') }}" style="color: #dc3545;">
                        <i class="bi bi-box-arrow-right me-2"></i>
                        <span>Cerrar sesión</span>
                      </a>
                    </li>
                  </ul>
                </div>
              {% endif %}
            </div>
          </div>
        </nav>
      </header>
      <!--  Header End -->
      {% if get_flashed_messages() %}
        <div class="alert alert-primary mb-0 text-center" role="alert"> 
            {{get_flashed_messages() | join("") }}
        </div>
      {% endif %}
      <div class="container-fluid">
        <div class="row">
            {% block main %} {% endblock %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="../static/libs/jquery/dist/jquery.min.js"></script>
  <script src="../static/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../static/libs/apexcharts/dist/apexcharts.min.js"></script>
  <script src="../static/libs/simplebar/dist/simplebar.js"></script>
  <script src="../static/js/sidebarmenu.js"></script>
  <script src="../static/js/app.min.js"></script>
  <script src="../static/js/dashboard.js"></script>

  <!-- Script para validación de formularios -->
  <script>
    // Función para sanitizar input
    function sanitizeInput(input) {
        return input.replace(/[<>]/g, '');
    }

    // Función para validar formularios
    function validateForm(form) {
        const inputs = form.querySelectorAll('input, textarea');
        let isValid = true;

        inputs.forEach(input => {
            // Sanitizar input
            if (input.value) {
                input.value = sanitizeInput(input.value);
            }

            // Validar campos requeridos
            if (input.hasAttribute('required') && !input.value.trim()) {
                isValid = false;
                input.classList.add('is-invalid');
                const feedback = input.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = 'Este campo es requerido';
                }
            } else {
                input.classList.remove('is-invalid');
            }

            // Validar email
            if (input.type === 'email' && input.value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(input.value)) {
                    isValid = false;
                    input.classList.add('is-invalid');
                    const feedback = input.nextElementSibling;
                    if (feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = 'Email inválido';
                    }
                }
            }

            // Validar números
            if (input.type === 'number' && input.value) {
                if (isNaN(input.value) || input.value < 0) {
                    isValid = false;
                    input.classList.add('is-invalid');
                    const feedback = input.nextElementSibling;
                    if (feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = 'Debe ser un número válido';
                    }
                }
            }

            // Validar longitud mínima
            if (input.hasAttribute('minlength')) {
                const minLength = parseInt(input.getAttribute('minlength'));
                if (input.value.length < minLength) {
                    isValid = false;
                    input.classList.add('is-invalid');
                    const feedback = input.nextElementSibling;
                    if (feedback && feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = `Mínimo ${minLength} caracteres`;
                    }
                }
            }
        });

        return isValid;
    }

    // Aplicar validación a todos los formularios
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                if (!validateForm(this)) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });

            // Validación en tiempo real
            const inputs = form.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (this.value) {
                        this.value = sanitizeInput(this.value);
                    }
                    validateForm(form);
                });

                input.addEventListener('blur', function() {
                    validateForm(form);
                });
            });
        });

        // Prevenir XSS en contenido dinámico
        const sanitizeContent = (content) => {
            const div = document.createElement('div');
            div.textContent = content;
            return div.innerHTML;
        };

        // Aplicar sanitización a contenido dinámico
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            const elements = node.querySelectorAll('[data-sanitize]');
                            elements.forEach(element => {
                                if (element.dataset.sanitize === 'true') {
                                    element.innerHTML = sanitizeContent(element.textContent);
                                }
                            });
                        }
                    });
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    });

    // Función para validar contraseña
    function validatePassword(password) {
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        const errors = [];
        if (password.length < minLength) {
            errors.push(`Mínimo ${minLength} caracteres`);
        }
        if (!hasUpperCase) {
            errors.push('Al menos una mayúscula');
        }
        if (!hasLowerCase) {
            errors.push('Al menos una minúscula');
        }
        if (!hasNumbers) {
            errors.push('Al menos un número');
        }
        if (!hasSpecialChar) {
            errors.push('Al menos un carácter especial');
        }

        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }

    // Aplicar validación de contraseña
    const passwordInputs = document.querySelectorAll('input[type="password"]');
    passwordInputs.forEach(input => {
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        input.parentNode.appendChild(feedback);

        input.addEventListener('input', function() {
            const result = validatePassword(this.value);
            if (this.value && !result.isValid) {
                this.classList.add('is-invalid');
                feedback.innerHTML = result.errors.join('<br>');
            } else {
                this.classList.remove('is-invalid');
                feedback.innerHTML = '';
            }
        });
    });
  </script>

  <!-- Script para manejar el sidebar en móvil -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elementos del DOM
      const sidebar = document.querySelector('.left-sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const mobileToggle = document.getElementById('mobileSidebarToggle');
      const closeBtn = document.getElementById('sidebarCollapse');
      
      // Función para mostrar/ocultar el sidebar
      function toggleSidebar() {
        if (sidebar.classList.contains('show')) {
          sidebar.classList.remove('show');
          overlay.classList.remove('show');
          document.body.style.overflow = '';
        } else {
          sidebar.classList.add('show');
          overlay.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }
      
      // Event listeners
      if (mobileToggle) {
        mobileToggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
      }
      
      if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
      }
      
      if (overlay) {
        overlay.addEventListener('click', function() {
          toggleSidebar();
        });
      }
      
      // Cerrar sidebar al hacer clic en un enlace
      const sidebarLinks = document.querySelectorAll('.sidebar-link');
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
          if (window.innerWidth < 992) {
            toggleSidebar();
          }
        });
      });

      // Cerrar sidebar al redimensionar la ventana
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 992 && sidebar.classList.contains('show')) {
          toggleSidebar();
        }
      });
    });
  </script>

  {% if session.get('rol') in ['admin', 'mesero', 'cocinero'] %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let notificaciones = [];
      const notificacionesLista = document.getElementById('notificaciones-lista');
      const notificacionesBadge = document.getElementById('notificaciones-badge');
      const marcarTodasLeidas = document.getElementById('marcar-todas-leidas');

      function actualizarNotificaciones() {
        fetch('/notificaciones')
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error('Error:', data.error);
              return;
            }
            notificaciones = data;
            actualizarInterfaz();
          })
          .catch(error => console.error('Error al obtener notificaciones:', error));
      }

      function actualizarInterfaz() {
        const noLeidas = notificaciones.filter(n => !n.leida).length;
        
        // Actualizar badge y su visibilidad
        if (noLeidas > 0) {
          notificacionesBadge.textContent = noLeidas;
          notificacionesBadge.style.display = 'block';
        } else {
          notificacionesBadge.style.display = 'none';
        }

        // Actualizar lista de notificaciones
        if (notificaciones.length === 0) {
          notificacionesLista.innerHTML = '<div class="text-center py-3 text-muted">No hay notificaciones pendientes</div>';
          return;
        }

        notificacionesLista.innerHTML = '';
        notificaciones.forEach(notif => {
          const item = document.createElement('div');
          item.className = `dropdown-item p-3 mb-2 ${notif.leida ? '' : 'bg-light'} rounded`;
          item.style.border = notif.leida ? 'none' : '1px solid #e9ecef';
          
          const productosList = notif.detalles.productos
            .map(p => `${p.cantidad}x ${p.nombre}`)
            .join('<br>');
          
          item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <strong class="text-primary">${notif.mensaje}</strong>
                  ${!notif.leida ? `
                    <button class="btn btn-sm btn-link text-success p-0 marcar-leida" 
                            data-id="${notif.id}" title="Marcar como leída">
                      <i class="bi bi-check2-circle"></i>
                    </button>
                  ` : ''}
                </div>
                <div class="small text-muted mb-2">
                  <i class="bi bi-clock"></i> ${notif.fecha}
                </div>
                <div class="small mb-2">
                  <i class="bi bi-person"></i> ${notif.detalles.cliente}
                </div>
                <div class="small mb-2">
                  ${productosList}
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                  <span class="badge bg-primary">
                    <i class="bi bi-box"></i> ${notif.detalles.total_productos} productos
                  </span>
                  <strong class="text-success">
                    C$${notif.detalles.total_monto.toFixed(2)}
                  </strong>
                </div>
              </div>
            </div>
          `;
          notificacionesLista.appendChild(item);
        });

        // Agregar event listeners a los botones de marcar como leída
        document.querySelectorAll('.marcar-leida').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const id = this.dataset.id;
            marcarComoLeida(id);
          });
        });
      }

      function marcarComoLeida(id) {
        fetch(`/marcar_notificacion_leida/${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error:', data.error);
            return;
          }
          actualizarNotificaciones();
        })
        .catch(error => console.error('Error al marcar notificación como leída:', error));
      }

      marcarTodasLeidas.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        notificaciones.forEach(notif => {
          if (!notif.leida) {
            marcarComoLeida(notif.id);
          }
        });
      });

      // Actualizar notificaciones cada 30 segundos
      actualizarNotificaciones();
      setInterval(actualizarNotificaciones, 30000);
    });
  </script>
  {% endif %}

  <script>
    // Sistema de atajos de teclado
    document.addEventListener('DOMContentLoaded', function() {
        const ATJOS = {
            'p': '/mesas', // Pedidos
            'h': '/historial', // Historial
            'c': '/clientes',  // Clientes
            'f': '/facturacion', // Facturación
            'i': '/ingresoproducto', // Ingreso de productos
            'r': '/registro',  // Registro
            'e': '/empleados',  // Empleados
            'x': '/cierre-corte' // Cierre de Corte
        };

        // Función para mostrar el modal de ayuda de atajos
        function showShortcutsHelp() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'shortcutsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-keyboard me-2"></i>
                                Atajos de Teclado
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="shortcuts-grid">
                                ${Object.entries(ATJOS).map(([key, url]) => `
                                    <div class="shortcut-item">
                                        <div class="shortcut-key">${key}</div>
                                        <div class="shortcut-arrow">→</div>
                                        <div class="shortcut-desc">${url.split('/')[1].replace(/_/g, ' ')}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-3 text-muted small">
                                <i class="bi bi-info-circle me-1"></i>
                                Presiona <kbd>?</kbd> en cualquier momento para ver esta ayuda
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Añadir estilos
            const style = document.createElement('style');
            style.textContent = `
                .shortcuts-grid {
                    display: grid;
                    gap: 1rem;
                    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                }
                .shortcut-item {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    padding: 0.5rem;
                    background: var(--bs-light);
                    border-radius: 0.5rem;
                }
                .shortcut-key {
                    background: var(--bs-primary);
                    color: white;
                    padding: 0.25rem 0.5rem;
                    border-radius: 0.25rem;
                    font-weight: bold;
                    min-width: 2rem;
                    text-align: center;
                }
                .shortcut-arrow {
                    color: var(--bs-gray);
                }
                .shortcut-desc {
                    font-weight: 500;
                }
                kbd {
                    background: var(--bs-dark);
                    color: white;
                    padding: 0.1rem 0.4rem;
                    border-radius: 0.25rem;
                    font-size: 0.9em;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);

            // Inicializar y mostrar el modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            // Limpiar el modal cuando se cierre
            modal.addEventListener('hidden.bs.modal', function () {
                modal.remove();
            });
        }

        // Mostrar ayuda al hacer clic en el botón
        document.getElementById('shortcutsHelpBtn').addEventListener('click', showShortcutsHelp);

        // Función para verificar si estamos en un campo de entrada
        function isInputField(element) {
            if (!element) return false;
            return element.tagName === 'INPUT' || 
                   element.tagName === 'TEXTAREA' || 
                   element.isContentEditable ||
                   element.closest('input, textarea, [contenteditable]');
        }

        // Función para manejar los atajos
        function handleShortcut(e) {
            // Ignorar si estamos en un campo de entrada
            if (isInputField(e.target)) {
                return;
            }

            // Ignorar si se presiona Ctrl, Alt, Shift o Meta
            if (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey) {
                return;
            }

            // Si la tecla es una letra
            if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                const key = e.key.toLowerCase();
                
                // Verificar si la tecla es un atajo
                if (ATJOS[key]) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Mostrar indicador visual
                    const indicator = document.createElement('div');
                    indicator.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        background: #fff;
                        padding: 10px 15px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        font-size: 0.9rem;
                        color: #333;
                        z-index: 1000;
                        border: 1px solid #ddd;
                    `;
                    indicator.textContent = `Atajo: ${key} → ${ATJOS[key].split('/')[1]}`;
                    document.body.appendChild(indicator);
                    
                    // Navegar después de un breve delay
                    setTimeout(() => {
                        window.location.href = ATJOS[key];
                    }, 300);
                }
            }
        }

        // Añadir el manejador de eventos
        document.addEventListener('keydown', handleShortcut);

        // Mostrar ayuda de atajos al presionar ?
        document.addEventListener('keydown', function(e) {
            if (e.key === '?' && !isInputField(e.target)) {
                e.preventDefault();
                e.stopPropagation();
                showShortcutsHelp();
            }
        });
    });
  </script>
</body>

</html>
