<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Restaurante</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-title {
            font-weight: 600;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .badge-lg {
            font-size: 1rem;
            padding: 0.5em 0.75em;
        }
        .total-sales {
            font-size: 1.75rem;
            color: #2a6496;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h2 class="mb-4">Dashboard del Restaurante</h2>

        <!-- Sección de Resumen -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <h5 class="card-title">Ventas de Hoy</h5>
                    <h3>C${{ ventas_dia }}</h3>
                    <small class="text-muted">vs. ayer: +12%</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h5 class="card-title">Órdenes Hoy</h5>
                    <h3>{{ ordenes_dia }}</h3>
                    <small class="text-muted">Promedio: {{ (ordenes_dia/12)|round(1) }} por hora</small>
                </div>
            </div>
            
            <div class="col-md-3">
                <a href="{{ url_for('clientes') }}" class="text-decoration-none">
                    <div class="card p-3 clickable-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Clientes Hoy</h5>
                                <h3>{{ clientes_dia }}</h3>
                                <small class="text-muted">
                                    {{ ((clientes_dia/ordenes_dia)*100)|round(1) if ordenes_dia > 0 else 0 }}% recurrentes
                                </small>
                            </div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <a href="{{ url_for('facturacion') }}" class="text-decoration-none">
                    <div class="card p-3 clickable-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Ventas Totales</h5>
                                <h3 class="total-sales">C${{ ventas_totales }}</h3>
                                <small class="text-muted">Promedio mensual: C${{ (ventas_totales/12)|round(2) }}</small>
                            </div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    </div>
                </a>
            </div>

        <!-- Sección de Gráficos -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card p-3">
                    <h5 class="card-title">Desempeño Mensual</h5>
                    <div class="chart-container">
                        <canvas id="ventasChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3">
                    <h5 class="card-title">Resumen Mensual</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th class="text-end">Ventas</th>
                                    <th class="text-end">% Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'] %}
                                {% for i in range(12) %}
                                <tr>
                                    <td>{{ meses[i] }}</td>
                                    <td class="text-end">C${{ ventas_mensuales[i] }}</td>
                                    <td class="text-end">{{ ((ventas_mensuales[i]/ventas_totales)*100)|round(1) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <th>Total</th>
                                    <th class="text-end">C${{ ventas_totales }}</th>
                                    <th class="text-end">100%</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Productos -->
        <div class="row">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="card-title">Productos Más Vendidos</h5>
                    <ul class="list-group">
                        {% for producto in productos_mas_vendidos %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ producto[0] }}
                            <span class="badge bg-success rounded-pill badge-lg">{{ producto[1] }} unidades</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h5 class="card-title">Mejores Meses</h5>
                    <div class="chart-container">
                        <canvas id="topMonthsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gráfico de ventas mensuales
        const ventasCtx = document.getElementById('ventasChart');
        const ventasChart = new Chart(ventasCtx, {
            type: 'bar',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [{
                    label: 'Ventas Mensuales (C$)',
                    data: {{ ventas_mensuales|tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Córdobas (C$)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'C$' + context.raw.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Gráfico de mejores meses (ejemplo)
        const topMonthsCtx = document.getElementById('topMonthsChart');
        const topMonthsChart = new Chart(topMonthsCtx, {
            type: 'doughnut',
            data: {
                labels: {{ meses_top|tojson|safe }},
                datasets: [{
                    data: {{ ventas_top|tojson|safe }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': C$' + context.raw.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>