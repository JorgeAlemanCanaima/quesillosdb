<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pedidos</title>
  <link rel="shortcut icon" type="image/png" href="../static/images/logos/logo.jpg" />
  <link rel="stylesheet" href="../static/css/styles.min.css" />
  <style>
    /* Estilos personalizados */
    .category-menu {
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow-y: auto;
      max-height: 400px;
    }
    .category-item {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .category-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
    }
    .product-table {
      max-height: 400px; /* Ajuste dinámico de altura */
      overflow-y: auto;
      display: block;
      width: 100%;
    }
    .order-table tbody {
      max-height: 220px; /* Altura para 3 filas aproximadamente */
      overflow-y: auto;
      display: block;
    }
    
    .order-table thead, .order-table tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    .totals-container {
      margin-top: 15px;
    }
    .container-fluid {
    display: flex;
    flex-direction: column;
    height: 100vh; /* Ocupa toda la altura de la pantalla */
  }

  .encabezado {
    flex: 0 0 20%; /* Ocupa el 20% de la altura total */
    display: flex;
    flex-direction: column;
    justify-content: center; /* Centrar verticalmente el contenido */
    align-items: center; /* Centrar horizontalmente el contenido */
    border-radius: 10px; /* Bordes redondeados opcionales */
  }

  .contenido {
    flex: 1; /* Ocupa el resto del espacio (80%) */
    overflow-y: auto; /* Permite el scroll si el contenido es mayor al área */
    margin-top: 10px;
  }

  .product-table-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden; /* Evita que el contenido exceda la altura */
  }

  .product-table-container h3 {
    margin-bottom: 10px;
  }

  .product-table {
    width: 100%; /* Ancho completo de la columna */
    flex: 1; /* Ocupa el espacio vertical disponible */
    overflow-y: auto; /* Scroll vertical si hay demasiados productos */
  }

  /* Estilos para el modal de meseros */
  .mesero-card {
    border: 2px solid #dee2e6;
    border-radius: 15px;
    transition: all 0.3s ease;
  }

  .mesero-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-color: #0d6efd;
  }

  .mesero-card.selected {
    border-color: #198754;
    background-color: #f8f9fa;
  }

  .mesero-avatar {
    width: 80px;
    height: 80px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #e9ecef;
    border-radius: 50%;
  }

  /* Estilos para botones táctiles */
  .btn-lg {
    padding: 1rem 2rem;
    font-size: 1.25rem;
    border-radius: 10px;
  }

  /* Ajustes para pantallas táctiles */
  @media (max-width: 768px) {
    .modal-dialog {
      margin: 0.5rem;
    }
    
    .mesero-card {
      margin-bottom: 1rem;
    }
    
    .btn-lg {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }

</style>
</head>
<body style="background-color: #f2f2f2;">
  <div class="container-fluid">
    <div class="row mt-3 mx-3">
        <div class="col-12">
            <a href="{{ url_for('mesas1') }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Volver a Mesas
            </a>
        </div>
    </div>

    <div class="row encabezado mx-3 mt-3">
      <div class="card shadow">
        <div class="card-body m-3 d-flex align-items-center justify-content-between">
          <div class="div">
            <h2 class="mb-0">Atendiendo Mesa: {{ mesa_nombre }}</h2>
            <p class="mb-0">Fecha: {{ fecha }}</p>
          </div>
          <div class="nombre-cliente-input mb-3">
            <label for="input1" class="form-label mx-1">Nombre Cliente</label>
              <input id= "nombre_cliente" name="nombre_cliente" type="text" class="form-control" id="input1" placeholder="(opcional)">
          </div>

          <button id="submit-order" type="submit" class="btn btn-primary mt-3">Ordenar</button>

        </div>
      </div>

    </div>
    <!-- Campo de búsqueda -->
<div class="mb-2">
  <input type="text" id="search-product" class="form-control" placeholder="Buscar producto...">
</div>

<script>
  document.getElementById('search-product').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#product-table-body tr');

    rows.forEach(row => {
      const productName = row.children[1].textContent.toLowerCase();
      row.style.display = productName.includes(searchTerm) ? '' : 'none';
    });
  });
</script>

    <div  class="card shadow mx-3">
      <div class="row contenido mx-3">
        <div class="col-lg-2">
            <h5>Categorías</h5>
            <div class="category-menu" id="category-menu">
                <!-- Categorías estáticas -->
            </div>
        </div>
        <div class="col-lg-4">
            <h3>Productos</h3>
            <div class="table-responsive">
              <table class="table w-100 text-wrap align-middle mb-0 product-table">
                <thead>
                  <tr class="border-2 border-bottom border-primary border-0">
                    <th style="width: 12.00%;" class="flex-fill">ID</th>
                    <th style="width: 30.00%;" class="flex-fill">Nombre</th>
                    <th style="width: 15.00%;" class="flex-fill">Stock</th>
                    <th style="width: 23.00%;" class="flex-fill">Precio</th>
                    <th style="width: 20.00%;" class="flex-fill">Accion</th>
                  </tr>
                </thead>
                <tbody id="product-table-body">
                  <!-- Filas dinámicas para productos -->
                </tbody>
              </table>
            </div>

        </div>
    
        <!-- Tabla de pedido -->
        <div class="col-lg-6">
            <h3>Pedido</h3>
            <div class="table-responsive">
              <table class="table text-wrap align-middle mb-0 order-table ">
                <thead>
                  <tr class="border-2 border-bottom border-primary border-0">
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                    <th>
                    </th>
                  </tr>
                </thead>
                <tbody id="order-table-body">
                  <!-- Filas dinámicas para productos del pedido -->
                </tbody>
              </table>
            </div>

    
            <!-- Totales -->
             <div class="card shadow-sm mt-2">
              <div class="card-body">
                <div class="totals-container">
                  <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Subtotal:</label>
                    <div class="col-sm-8">
                      <input type="text" id="subtotal" class="form-control" readonly>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-4 col-form-label">PROPINA (10%):</label>
                    <div class="col-sm-8">
                      <input type="text" id="iva" class="form-control" readonly>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Total:</label>
                    <div class="col-sm-8">
                      <input type="text" id="total" class="form-control" readonly>
                    </div>
                  </div>
                </div>
              </div>
             </div>
            
        </div>
    </div>
    </div>

    
    <script>
        const categories = [
          { id: 1, name: "desayuno", image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR3TfoRscnBjdgIrOT8CMxlpmKbpRs5G8jJgA&s" },
          { id: 2, name: "asados", image: "https://chefmont.com/wp-content/uploads/2019/09/asados.jpg" },
          { id: 3, name: "quesillo", image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSRknQpUj8_JUK4yttG_JDjimSNlK_EaP4OoQ&s" },
          { id: 4, name: "bebidas", image: "https://s3.amazonaws.com/images.ecwid.com/images/29960109/1540948372.jpg" },
          { id: 5, name: "antojos tipicos", image: "https://i.pinimg.com/originals/5b/ea/4c/5bea4c73230d111ad53384bfaa3bac58.jpg" },
          { id: 5, name: "postres", image: "https://www.elmueble.com/medio/2023/12/14/ideas-de-postres-para-navidad-que-puedes-preparar-con-antelacion-y-congelar_0cf3e42e_231128110103_231214150004_900x900.jpg" },
          { id: 5, name: "extras", image: "https://static01.nyt.com/images/2024/08/06/multimedia/11EATrex-flour-tortillas-mvfk/11EATrex-flour-tortillas-mvfk-googleFourByThree.jpg" }
        ];
    
        const orderItems = [];
    
        function loadCategories() {
          const categoryMenu = document.getElementById('category-menu');
          categoryMenu.innerHTML = '';
          categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';
            categoryItem.innerHTML = `
              <img src="${category.image}" alt="${category.name}">
              <span>${category.name}</span>
            `;
            categoryItem.onclick = () => loadProducts(category.name);
            categoryMenu.appendChild(categoryItem);
          });
        }
    
        function loadProducts(categoryName) {
          fetch(`/products/${categoryName}`)
            .then(response => response.json())
            .then(products => {
              const productTableBody = document.getElementById('product-table-body');
              productTableBody.innerHTML = '';
              products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${product.id}</td>
                  <td>${product.nombre}</td>
                  <td>${product.stock}</td>
                  <td>C$${Number(product.precio).toFixed(2)}</td>
                  <td><button onclick="addToOrder(${product.id}, '${product.nombre}', ${product.precio}, ${product.stock})" class="btn btn-primary btn-sm" ${product.stock <= 0 ? 'disabled' : ''}>Añadir</button></td>
                `;
                productTableBody.appendChild(row);
              });
            });
        }
    
        function addToOrder(id, nombre, precio, stock) {
          const existingItem = orderItems.find(item => item.id === id);
          if (existingItem) {
            if (existingItem.cantidad < stock) {
              existingItem.cantidad++;
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Stock insuficiente',
                text: 'No hay suficiente stock disponible para este producto.',
                confirmButtonText: 'Aceptar'
              });
              return;
            }
          } else {
            if (stock > 0) {
              orderItems.push({ id, nombre, precio, cantidad: 1, stock });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Stock agotado',
                text: 'Este producto no tiene stock disponible.',
                confirmButtonText: 'Aceptar'
              });
              return;
            }
          }
          renderOrderTable();
          calculateTotals();
          updateStockDisplay(id, stock - (existingItem ? existingItem.cantidad : 1));
        }

        function updateStockDisplay(productId, newStock) {
          const rows = document.querySelectorAll('#product-table-body tr');
          rows.forEach(row => {
            if (row.cells[0].textContent === productId.toString()) {
              row.cells[2].textContent = newStock;
              // Deshabilitar el botón si no hay stock
              const addButton = row.querySelector('button');
              if (newStock <= 0) {
                addButton.disabled = true;
                addButton.classList.add('btn-secondary');
                addButton.classList.remove('btn-primary');
              }
            }
          });
        }

        function updateQuantity(id, cantidad) {
          const item = orderItems.find(item => item.id === id);
          if (item) {
            const newCantidad = parseInt(cantidad);
            if (isNaN(newCantidad) || newCantidad < 1) {
              // Si la cantidad no es válida, restaurar al valor anterior
              const input = document.querySelector(`input[data-product-id="${id}"]`);
              if (input) {
                input.value = item.cantidad;
              }
              return;
            }

            if (newCantidad <= item.stock) {
              item.cantidad = newCantidad;
              renderOrderTable();
              calculateTotals();
              updateStockDisplay(id, item.stock - newCantidad);
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Stock insuficiente',
                text: 'No hay suficiente stock disponible para esta cantidad.',
                confirmButtonText: 'Aceptar'
              });
              // Restaurar la cantidad anterior
              const input = document.querySelector(`input[data-product-id="${id}"]`);
              if (input) {
                input.value = item.cantidad;
              }
            }
          }
        }
    
        function renderOrderTable() {
          const orderTableBody = document.getElementById('order-table-body');
          orderTableBody.innerHTML = '';
          orderItems.forEach(item => {
            const total = item.precio * item.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.nombre}</td>
              <td>C$${item.precio.toFixed(2)}</td>
              <td>
                <div class="input-group">
                  <button class="btn btn-outline-secondary btn-sm" onclick="decrementQuantity(${item.id})">-</button>
                  <input type="number" 
                         value="${item.cantidad}" 
                         min="1" 
                         max="${item.stock}"
                         data-product-id="${item.id}"
                         onchange="updateQuantity(${item.id}, this.value)" 
                         class="form-control text-center"
                         style="width: 60px;">
                  <button class="btn btn-outline-secondary btn-sm" onclick="incrementQuantity(${item.id})">+</button>
                </div>
              </td>
              <td>C$${total.toFixed(2)}</td>
              <td>
                <button onclick="removeFromOrder(${item.id})" class="btn btn-danger btn-sm">
                  <img src="../static/images/logos/delete.png" alt="Eliminar" width="16" height="16">
                </button>
              </td>
            `;
            orderTableBody.appendChild(row);
          });
        }
    
        function calculateTotals() {
          let subtotal = 0;
          orderItems.forEach(item => {
            subtotal += item.precio * item.cantidad;
          });
          const iva = subtotal * 0.10;
          const total = subtotal + iva;
    
          document.getElementById('subtotal').value = `C$${subtotal.toFixed(2)}`;
          document.getElementById('iva').value = `C$${iva.toFixed(2)}`;
          document.getElementById('total').value = `C$${total.toFixed(2)}`;
        }
        
        function incrementQuantity(id) {
          const item = orderItems.find(item => item.id === id);
          if (item && item.cantidad < item.stock) {
            updateQuantity(id, item.cantidad + 1);
          } else if (item && item.cantidad >= item.stock) {
            Swal.fire({
              icon: 'error',
              title: 'Stock insuficiente',
              text: 'No hay más stock disponible para este producto.',
              confirmButtonText: 'Aceptar'
            });
          }
        }

        function decrementQuantity(id) {
          const item = orderItems.find(item => item.id === id);
          if (item && item.cantidad > 1) {
            updateQuantity(id, item.cantidad - 1);
          }
        }
        
        document.addEventListener('DOMContentLoaded', loadCategories);
    </script>

<script>
  document.getElementById('search-product').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    fetch(`/all_products`)
      .then(response => response.json())
      .then(products => {
        const productTableBody = document.getElementById('product-table-body');
        productTableBody.innerHTML = '';

        products.forEach(product => {
          if (product.nombre.toLowerCase().includes(searchTerm)) {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${product.id}</td>
              <td>${product.nombre}</td>
              <td>${product.stock}</td>
              <td>C$${Number(product.precio).toFixed(2)}</td>
              <td><button onclick="addToOrder(${product.id}, '${product.nombre}', ${product.precio}, ${product.stock})" class="btn btn-primary btn-sm" ${product.stock <= 0 ? 'disabled' : ''}>Añadir</button></td>
            `;
            productTableBody.appendChild(row);
          }
        });
      });
  });

  function removeFromOrder(id) {
    const itemIndex = orderItems.findIndex(item => item.id === id);
    if (itemIndex !== -1) {
      const removedItem = orderItems[itemIndex];
      // Restaurar el stock original
      updateStockDisplay(id, removedItem.stock);
      orderItems.splice(itemIndex, 1);
      renderOrderTable();
      calculateTotals();
    }
  }
</script>


  </div>
  <script src="../static/libs/jquery/dist/jquery.min.js"></script>
  <script src="../static/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../static/libs/apexcharts/dist/apexcharts.min.js"></script>
  <script src="../static/libs/simplebar/dist/simplebar.js"></script>
  <script src="../static/js/sidebarmenu.js"></script>
  <script src="../static/js/app.min.js"></script>
  <script src="../static/js/dashboard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

  <script>
    document.getElementById('submit-order').addEventListener('click', function() {
      if (!meseroSeleccionado) {
        Swal.fire({
          icon: 'warning',
          title: 'Mesero no seleccionado',
          text: 'Por favor seleccione un mesero antes de procesar el pedido.',
          confirmButtonText: 'Aceptar'
        }).then(() => {
          const meseroModal = new bootstrap.Modal(document.getElementById('meseroModal'));
          meseroModal.show();
        });
        return;
      }
      
      // Recopila los datos del pedido
      const orderData = orderItems.map(item => ({
        id: item.id,
        nombre: item.nombre,
        precio: item.precio,
        cantidad: item.cantidad,
        total: (item.precio * item.cantidad).toFixed(2)
      }));

      if (orderData.length === 0) {
        Swal.fire({
          icon: 'error',
          title: 'Pedido vacío',
          text: 'Agrega productos antes de enviar el pedido.',
          confirmButtonText: 'Aceptar'
        });
        return;
      }

      //obtenemos el nombre del cliente
      const clienteInput = document.getElementById('nombre_cliente');
      const cliente = clienteInput ? clienteInput.value.trim() : '';
  
      const urlParams = new URLSearchParams(window.location.search);
      const mesaId = urlParams.get('mesa_id');
  
      if (!mesaId) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'No se pudo obtener el ID de la mesa.',
          confirmButtonText: 'Aceptar'
        });
        return;
      }
  
      // Enviar los datos al servidor
      fetch(`/atender_mesa/${mesaId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          orderData, 
          cliente,
          mesero_id: meseroSeleccionado.id
        }),
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.error || 'Error al procesar el pedido'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.redirect) {
          Swal.fire({
            icon: 'success',
            title: 'Pedido realizado correctamente',
            text: 'Tu pedido ha sido procesado con éxito.',
            confirmButtonText: 'Aceptar'
          }).then(() => {
            window.location.href = data.redirect;
          });
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message,
          confirmButtonText: 'Aceptar'
        });
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Modal de Selección de Mesero -->
  <div class="modal fade" id="meseroModal" tabindex="-1" aria-labelledby="meseroModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="meseroModalLabel">
                    <i class="bi bi-person-badge me-2"></i>
                    Seleccione el Mesero
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row row-cols-2 row-cols-md-3 g-4">
                    {% for mesero in meseros %}
                    <div class="col">
                        <div class="card h-100 mesero-card" 
                             data-mesero-id="{{ mesero.id }}"
                             onclick="seleccionarMesero(this, '{{ mesero.id }}', '{{ mesero.nombre_user }}')"
                             style="cursor: pointer; transition: all 0.3s ease;">
                             
                            <div class="card-body text-center">
                                <div class="mesero-avatar mb-3">
                                    <img src="{{ mesero.foto_url or url_for('static', filename='images/logos/ethan.png') }} "   alt="Mesero" width="300">
                                    <i class="bi bi-person-circle" style="font-size: 3rem; color: #0d6efd;"></i>
                                </div>
                                <h5 class="card-title">{{ mesero.nombre_user }}</h5>
                                <div class="mesero-selected-indicator d-none">
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="confirmarMesero">
                    <i class="bi bi-check-circle me-2"></i>Confirmar Mesero
                </button>
            </div>
        </div>
    </div>
  </div>

  <script>
    let meseroSeleccionado = null;

    function seleccionarMesero(card, meseroId, meseroNombre) {
        // Deseleccionar todas las tarjetas
        document.querySelectorAll('.mesero-card').forEach(c => {
            c.classList.remove('selected');
            c.querySelector('.mesero-selected-indicator').classList.add('d-none');
        });
        
        // Seleccionar la tarjeta actual
        card.classList.add('selected');
        card.querySelector('.mesero-selected-indicator').classList.remove('d-none');
        
        // Guardar la selección
        meseroSeleccionado = {
            id: meseroId,
            nombre: meseroNombre
        };
        
        // Actualizar el select oculto
        const meseroSelect = document.getElementById('meseroSelect');
        meseroSelect.value = meseroId;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar modal de mesero al cargar la página
        const meseroModal = new bootstrap.Modal(document.getElementById('meseroModal'));
        meseroModal.show();

        // Manejar la selección del mesero
        document.getElementById('confirmarMesero').addEventListener('click', function() {
            if (!meseroSeleccionado) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Seleccione un Mesero',
                    text: 'Por favor, seleccione un mesero antes de continuar.',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }
            meseroModal.hide();
        });
    });
  </script>

</body>
</html>