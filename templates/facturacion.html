{% extends "layout.html" %}

{% block title %}Facturación{% endblock %}

{% block extra_head %}

<!-- Incluir jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
    .table-responsive {
        overflow-x: auto;
    }
    .filter-container {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .status-badge {
        font-size: 0.85em;
        padding: 5px 10px;
        border-radius: 10px;
    }
    .badge-pendiente {
        background-color: #ffc107;
        color: #212529;
    }
    .badge-pagada {
        background-color: #28a745;
        color: white;
    }
    .action-buttons .btn {
        margin-right: 5px;
    }
    .modal-print {
        max-width: 80%;
    }
    .factura-header {
        text-align: center;
        margin-bottom: 20px;
    }
    .factura-info {
        margin-bottom: 30px;
    }
    .factura-table {
        width: 100%;
        margin-bottom: 20px;
    }
    .factura-table th {
        background-color: #f8f9fa;
        text-align: center;
    }
    .factura-totales {
        margin-top: 20px;
        float: right;
        width: 300px;
    }
    @media print {
        .no-print {
            display: none !important;
        }
        body {
            font-size: 12pt;
            background: white;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 100%;
            padding: 0;
        }
    }
</style>
{% endblock %}

{% block main %}
<div class="container mt-4">
    <h1 class="mb-4">Gestión de Facturas</h1>
    
    <div class="filter-container no-print">
        <form method="GET" action="{{ url_for('facturacion') }}" class="row g-3">
            <div class="col-md-4">
                <label for="estado" class="form-label">Estado:</label>
                <select name="estado" id="estado" class="form-select">
                    <option value="">Todos</option>
                    <option value="pendiente" {% if estado_seleccionado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="pagada" {% if estado_seleccionado == 'pagada' %}selected{% endif %}>Pagada</option>
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="rango_fecha" class="form-label">Rango de fechas:</label>
                <select name="rango_fecha" id="rango_fecha" class="form-select">
                    <option value="">Todos</option>
                    <option value="hoy" {% if rango_fecha_seleccionado == 'hoy' %}selected{% endif %}>Hoy</option>
                    <option value="ultimos_7_dias" {% if rango_fecha_seleccionado == 'ultimos_7_dias' %}selected{% endif %}>Últimos 7 días</option>
                    <option value="ultimo_mes" {% if rango_fecha_seleccionado == 'ultimo_mes' %}selected{% endif %}>Último mes</option>
                </select>
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <a href="{{ url_for('facturacion') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> Limpiar
                </a>
            </div>
        </form>
    </div>

    <div class="table-responsive">
        {% if facturas %}
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Cliente</th>
                    <th>Código</th>
                    <th>Pedido ID</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th class="no-print">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for factura in facturas %}
                <tr>
                    <td>{{ factura['nombre'] }}</td>
                    <td>{{ factura['codigo'] }}</td>
                    <td>{{ factura['pedido_id'] }}</td>
                    <td>C${{ "%.2f"|format(factura['monto']) }}</td>
                    <td>
                        {% if factura['fecha_hora'] is string %}
                            {{ factura['fecha_hora'][:10] }} {{ factura['fecha_hora'][11:16] }}
                        {% else %}
                            {{ factura['fecha_hora'].strftime('%d/%m/%Y %H:%M') }}
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge badge-{{ factura['estado'] }}">
                            {{ factura['estado'].capitalize() }}
                        </span>
                    </td>
                    <td class="action-buttons no-print">
                        <button type="button" 
                                class="btn btn-sm btn-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#facturaModal"
                                onclick="cargarDetalleFactura(
                                    '{{ factura['codigo'] }}',
                                    '{{ factura['nombre'] }}',
                                    '{{ factura['pedido_id'] }}',
                                    '{{ "%.2f"|format(factura['monto']) }}',
                                    '{% if factura['fecha_hora'] is string %}{{ factura['fecha_hora'][:10] }} {{ factura['fecha_hora'][11:16] }}{% else %}{{ factura['fecha_hora'].strftime('%d/%m/%Y %H:%M') }}{% endif %}',
                                    '{{ factura['estado'] }}',
                                    '{{ factura['num_mesa'] }}',
                                    '{{ factura['mesero'] }}'
                                )">
                            <i class="bi bi-eye"></i> Ver Factura
                        </button>
                        {% if factura['estado'] == 'pendiente' %}
                            <form action="{{ url_for('finalizar', mesa_id=factura['num_mesa'], pedido_id=factura['pedido_id']) }}" 
                                  method="post" 
                                  style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="bi bi-check-circle"></i> Marcar como Pagada
                                </button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No se encontraron facturas con los filtros seleccionados
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para ver factura -->
<div class="modal fade" id="facturaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-print">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Factura</h5>
                <button type="button" class="btn-close no-print" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="facturaModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p>Cargando detalles de la factura...</p>
                </div>
            </div>
            <div class="modal-footer no-print">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="generarPDF()">
                    <i class="bi bi-file-earmark-pdf"></i> Generar PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Declarar variable global para almacenar los datos de la factura
    let currentFactura = {};

    function cargarDetalleFactura(codigo, cliente, pedidoId, monto, fecha, estado, mesa, mesero) {
        currentFactura = {
            codigo: codigo,
            cliente: cliente,
            pedidoId: pedidoId,
            monto: parseFloat(monto),
            fecha: fecha,
            estado: estado,
            mesa: mesa,
            mesero: mesero
        };
        
        // Hacer una petición AJAX para obtener los productos
        fetch(`/pedido/${pedidoId}/data`)
            .then(response => response.json())
            .then(data => {
                currentFactura.productos = data.orderItems;
                currentFactura.subtotal = currentFactura.monto / 1.1;
                currentFactura.propina = currentFactura.monto - currentFactura.subtotal;
                mostrarDetalleFactura();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los productos');
            });
    }
    
    function mostrarDetalleFactura() {
        const modalBody = document.getElementById('facturaModalBody');
        
        // Generar filas de productos
        let productosHTML = '';
        if (currentFactura.productos && currentFactura.productos.length > 0) {
            currentFactura.productos.forEach(producto => {
                productosHTML += `
                    <tr>
                        <td>${producto.nombre}</td>
                        <td>C$${producto.precio.toFixed(2)}</td>
                        <td>${producto.cantidad}</td>
                        <td>C$${(producto.precio * producto.cantidad).toFixed(2)}</td>
                    </tr>
                `;
            });
        } else {
            productosHTML = '<tr><td colspan="4" class="text-center">No hay productos registrados</td></tr>';
        }
        
        const html = `
            <div class="factura-detalle" id="facturaContent">
                <div class="factura-header">
                    <h3>QUESILLOS LO NUESTRO</h3>
                    <p>DIR. CONTIGUO A CLARO ALTAMIRA</p>
                    <p>MANAGUA, NICARAGUA</p>
                    <p>TELÉFONO: 2277-4001</p>
                </div>
                
                <hr>
                
                <div class="factura-info">
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Numero de factura:</strong> ${currentFactura.codigo}</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>FECHA:</strong> ${currentFactura.fecha}</p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>MESA:</strong> ${currentFactura.mesa}</p>
                        </div>
                    </div>
                    <p><strong>CLIENTE:</strong> ${currentFactura.cliente}</p>
                    <p><strong>Atendido por:</strong> ${currentFactura.mesero}</p>
                </div>
                
                <table class="table table-bordered factura-table">
                    <thead>
                        <tr>
                            <th>PRODUCTOS</th>
                            <th>PRECIO UNITARIO</th>
                            <th>CANTIDAD</th>
                            <th>TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productosHTML}
                    </tbody>
                </table>
                
                <div class="factura-totales">
                    <table class="table">
                        <tr>
                            <td><strong>SUBTOTAL:</strong></td>
                            <td>C$${currentFactura.subtotal.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>PROPINA (10%):</strong></td>
                            <td>C$${currentFactura.propina.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>TOTAL:</strong></td>
                            <td>C$${currentFactura.monto.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="text-center mt-4">
                    <p>¡Gracias por su preferencia!</p>
                </div>
            </div>
        `;
        
        modalBody.innerHTML = html;
    }

    function generarPDF() {
        // Usar jsPDF (que ya está incluido vía CDN)
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configuración del PDF
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Encabezado de la factura
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('QUESILLOS LO NUESTRO', 105, 15, { align: 'center' });
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('DIR. CONTIGUO A CLARO ALTAMIRA', 105, 22, { align: 'center' });
        doc.text('MANAGUA, NICARAGUA', 105, 27, { align: 'center' });
        doc.text('TELÉFONO: 2277-4001', 105, 32, { align: 'center' });
        
        // Línea separadora
        doc.line(15, 37, 195, 37);
        
        // Información de la factura
        doc.setFontSize(12);
        doc.text(`ID_FACTURA: ${currentFactura.codigo}`, 20, 45);
        doc.text(`FECHA: ${currentFactura.fecha}`, 105, 45);
        doc.text(`MESA: ${currentFactura.mesa}`, 180, 45, { align: 'right' });
        doc.text(`CLIENTE: ${currentFactura.cliente}`, 20, 52);
        doc.text(`MESERO: ${currentFactura.mesero}`, 20, 59);

        
        // Tabla de productos
        const productosData = currentFactura.productos.map(p => [
            p.nombre,
            `C$${p.precio.toFixed(2)}`,
            p.cantidad,
            `C$${(p.precio * p.cantidad).toFixed(2)}`
        ]);
        
        doc.autoTable({
            startY: 65 ,
            head: [['PRODUCTOS', 'PRECIO UNITARIO', 'CANTIDAD', 'TOTAL']],
            body: productosData,
            margin: { left: 15, right: 15 },
            styles: { fontSize: 10 },
            headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0] }
        });
        
        // Totales
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.text(`SUBTOTAL: C$${currentFactura.subtotal.toFixed(2)}`, 160, finalY, { align: 'right' });
        doc.text(`PROPINA (10%): C$${currentFactura.propina.toFixed(2)}`, 160, finalY + 8, { align: 'right' });
        doc.setFont('helvetica', 'bold');
        doc.text(`TOTAL: C$${currentFactura.monto.toFixed(2)}`, 160, finalY + 16, { align: 'right' });
        
        // Pie de página
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.text('¡Gracias por su preferencia!', 105, finalY + 30, { align: 'center' });
        
        // Guardar el PDF
        doc.save(`Factura_${currentFactura.codigo}.pdf`);
    }

    // Configurar el modal para que se cargue cuando se muestre
    document.getElementById('facturaModal').addEventListener('show.bs.modal', function () {
        if (Object.keys(currentFactura).length > 0) {
            mostrarDetalleFactura();
        }
    });
</script>
{% endblock %}